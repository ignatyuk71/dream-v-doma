<template>
  <div class="container-lg">
    <main class="content-wrapper" v-if="order">
      <div class="row row-cols-1 row-cols-lg-2 g-0 mx-auto" style="max-width: 1920px">

        <!-- –õ—ñ–≤–∞ –∫–æ–ª–æ–Ω–∫–∞: —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è –ø—Ä–æ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è -->
        <div class="col d-flex flex-column justify-content-center py-5 px-xl-4 px-xxl-5">
          <div
            class="w-100 pt-sm-2 pt-md-3 pt-lg-4 pb-lg-4 pb-xl-5 px-3 px-sm-4 pe-lg-0 ps-lg-5 mx-auto ms-lg-auto me-lg-4"
            style="max-width: 740px"
          >
            <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
            <div class="d-flex align-items-sm-center border-bottom pb-4 pb-md-5">
              <div
                class="d-flex align-items-center justify-content-center bg-success text-white rounded-circle flex-shrink-0"
                style="width: 3rem; height: 3rem; margin-top: -.125rem"
              >
                <i class="ci-check fs-4"></i>
              </div>
              <div class="w-100 ps-3">
                <div class="fs-sm mb-1">–ó–∞–º–æ–≤–ª–µ–Ω–Ω—è ‚Ññ{{ order.order_number }}</div>
                <h1 class="h4 mb-0">–î—è–∫—É—î–º–æ –∑–∞ –≤–∞—à–µ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è!</h1>
                <p class="text-muted mb-0">
                  –ù–∞—à –º–µ–Ω–µ–¥–∂–µ—Ä –∑–≤ º—è–∂–µ—Ç—å—Å—è –∑ –≤–∞–º–∏ –Ω–∞–π–±–ª–∏–∂—á–∏–º —á–∞—Å–æ–º, —â–æ–± —É—Ç–æ—á–Ω–∏—Ç–∏ –¥–µ—Ç–∞–ª—ñ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è.
                </p>
              </div>
            </div>

            <!-- –Ü–Ω—Ñ–æ –∫–ª—ñ—î–Ω—Ç–∞ / –¥–æ—Å—Ç–∞–≤–∫–∏ -->
            <div class="d-flex flex-column gap-4 pt-3 pb-5 mt-3">
              <div class="d-flex flex-wrap gap-4 mb-4">
                <div>
                  <h6 class="h5 text-muted mb-1">–Ü–º‚Äô—è</h6>
                  <div class="fw-semibold">{{ order.customer?.name }}</div>
                </div>
                <div>
                  <h6 class="h5 text-muted mb-1">–¢–µ–ª–µ—Ñ–æ–Ω</h6>
                  <div class="fw-semibold">{{ order.customer?.phone }}</div>
                </div>
              </div>

              <div v-if="order.delivery">
                <h3 class="h5 mb-3">–î–æ—Å—Ç–∞–≤–∫–∞</h3>
                <p class="mb-0">
                  <template v-if="order.delivery.address && order.delivery.address !== '‚Äî'">
                    <span class="fw-semibold fs-6">{{ order.delivery.address }}</span><br>
                  </template>
                  <small class="text-muted">
                    {{ order.delivery.name && order.delivery.name !== '‚Äî' ? order.delivery.name : '–ö—É—Ä‚Äô—î—Ä—Å—å–∫–∞ –¥–æ—Å—Ç–∞–≤–∫–∞' }}
                  </small>
                </p>
              </div>

              <div>
                <h6 class="h5 text-muted mb-1">–û—á—ñ–∫—É–≤–∞–Ω–∞ –¥–æ—Å—Ç–∞–≤–∫–∞</h6>
                <div class="fs-sm">–ø—Ä–æ—Ç—è–≥–æ–º 1‚Äì2 —Ä–æ–±–æ—á–∏—Ö –¥–Ω—ñ–≤</div>
              </div>
            </div>

            <!-- –ö—É–ø–æ–Ω -->
            <div class="bg-success rounded px-4 py-4" style="--cz-bg-opacity: .2">
              <div class="py-3">
                <h2 class="h5 text-center pb-2 mb-1">üéâ –í—ñ—Ç–∞—î–º–æ! –ó–Ω–∏–∂–∫–∞ 30% –Ω–∞ –Ω–∞—Å—Ç—É–ø–Ω—É –ø–æ–∫—É–ø–∫—É!</h2>
                <p class="fs-sm text-center mb-4">–í–∏–∫–æ—Ä–∏—Å—Ç–∞–π—Ç–µ —Ü–µ–π –∫—É–ø–æ–Ω –∑–∞—Ä–∞–∑ –∞–±–æ –∑–Ω–∞–π–¥–µ—Ç–µ –π–æ–≥–æ —É —Å–≤–æ—î–º—É –∫–∞–±—ñ–Ω–µ—Ç—ñ.</p>
                <div class="d-flex gap-2 mx-auto" style="max-width: 500px">
                  <input type="text" class="form-control border-white border-opacity-10 w-100" id="couponCode" value="30%SALEOFF" readonly>
                  <button type="button" class="btn btn-dark" data-copy-text-from="#couponCode">–°–∫–æ–ø—ñ—é–≤–∞—Ç–∏</button>
                </div>
              </div>
            </div>

            <p class="fs-sm pt-4 pt-md-5 mt-2 mt-sm-3 mt-md-0 mb-0">
              –ü–æ—Ç—Ä—ñ–±–Ω–∞ –¥–æ–ø–æ–º–æ–≥–∞?
              <a class="fw-medium ms-2" :href="`/${$i18n.locale}/contact`">–ó–≤ º—è–∂—ñ—Ç—å—Å—è –∑ –Ω–∞–º–∏</a>
            </p>
          </div>
        </div>

        <!-- –ü—Ä–∞–≤–∞ –∫–æ–ª–æ–Ω–∫–∞: —Å–∫–ª–∞–¥ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è -->
        <div class="col-12 col-lg-6 px-3 px-sm-4 px-xl-5 py-5">
          <div class="bg-white border rounded-4 p-3 p-md-4 shadow-sm mx-auto" style="max-width: 636px">
            <h5 class="fw-bold mb-4">–í–∞—à–µ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è</h5>

            <div
              v-for="item in order.items"
              :key="item.id"
              class="d-flex align-items-center justify-content-between mb-3 pb-3 border-bottom"
            >
              <!-- –§–æ—Ç–æ + –¥–µ—Ç–∞–ª—ñ -->
              <div class="d-flex align-items-center">
                <img
                  :src="withStorage(item.image_url || item.product_image)"
                  @error="$event.target.src = '/assets/img/placeholder.jpg'"
                  class="rounded me-3"
                  style="width: 74px; height: 74px; object-fit: cover;"
                  alt="–§–æ—Ç–æ —Ç–æ–≤–∞—Ä—É"
                />
                <div>
                  <div class="fw-medium text-truncate" style="max-width: 360px">
                    {{ item.product_name }}
                  </div>

                  <!-- –†–æ–∑–º—ñ—Ä / –ö–æ–ª—ñ—Ä -->
                  <div class="small text-muted mt-1" v-if="item.size">
                    {{ $t('checkout.order.size') || '–†–æ–∑–º—ñ—Ä' }}:
                    <span class="fw-bold text-body">{{ item.size }}</span>
                  </div>
                  <div class="small text-muted mt-1" v-if="item.color">
                    {{ $t('product.color') || '–ö–æ–ª—ñ—Ä' }}:
                    <span class="fw-bold text-body">{{ item.color }}</span>
                  </div>

                  <!-- –ö—ñ–ª—å–∫—ñ—Å—Ç—å —ñ —Ü—ñ–Ω–∞ –∑–∞ –æ–¥–∏–Ω–∏—Ü—é -->
                  <div class="small mt-1">
                    <span class="text-muted">√ó {{ item.quantity }}</span>
                    <span class="ms-1">‚Ä¢</span>
                    <span class="fw-semibold ms-1">{{ money(item.price) }}</span>
                  </div>
                </div>
              </div>

              <!-- –°—É–º–∞ –ø–æ –ø–æ–∑–∏—Ü—ñ—ó -->
              <div class="fw-bold text-end" style="white-space: nowrap;">
                {{ money(lineTotal(item)) }}
              </div>
            </div>
          </div>
        </div>

      </div>
    </main>

    <div v-else class="container text-center py-5">
      <div class="spinner-border text-primary mb-3" role="status"></div>
      <p>Loading your order...</p>
    </div>
  </div>
</template>

<script setup>
import { ref, onMounted } from 'vue'
import axios from 'axios'
import { useI18n } from 'vue-i18n'
import { useCartStore } from '@/stores/cart'

const { t } = useI18n()
const cart = useCartStore()
const order = ref(null)

// ---- helpers
const toNumber = (v) => {
  if (typeof v === 'number') return v
  const n = parseFloat(String(v).replace(',', '.').replace(/[^\d.]/g, ''))
  return Number.isFinite(n) ? n : 0
}
const money     = (v) => `${toNumber(v).toFixed(2)} ${t('currency') || '–≥—Ä–Ω'}`
const lineTotal = (item) => toNumber(item.price) * toNumber(item.quantity)

const withStorage = (path) => {
  if (!path) return '/assets/img/placeholder.jpg'
  if (/^https?:\/\//i.test(path) || String(path).startsWith('//')) {
    try { path = new URL(path, window.location.origin).pathname } catch (_) {}
  }
  let p = String(path).replace(/^\/+/, '').replace(/^(?:app\/)?public\//, '')
  if (p.startsWith('storage/')) return '/' + p
  return '/storage/' + p
}

/* ================= Meta Pixel: Purchase (—á–µ—Ä–µ–∑ –≥–ª–æ–±–∞–ª–∫—É –∑ Blade) ================= */
const trackPurchaseOnce = (() => {
  let sent = false
  return (ord) => {
    console.groupCollapsed('%c[Purchase] prepare', 'color:#09f')
    try {
      if (sent) { console.info('‚Ä¢ skip: already sent'); console.groupEnd(); return }
      if (!ord || !Array.isArray(ord.items)) {
        console.warn('‚Ä¢ no order or items array', ord)
        console.groupEnd(); return
      }
      if (window._mpFlags && window._mpFlags.purchase === false) {
        console.info('‚Ä¢ skip by flag window._mpFlags.purchase=false'); console.groupEnd(); return
      }

      const rawItems = ord.items || []
      const withSku  = rawItems.filter(i => String(i?.variant_sku ?? '').trim().length > 0)
      const noSku    = rawItems.filter(i => !String(i?.variant_sku ?? '').trim().length)

      console.table(rawItems.map(i => ({
        id: i.id,
        variant_id: i.variant_id,
        variant_sku: i.variant_sku,
        size: i.size,
        price: i.price,
        qty: i.quantity,
        name: i.product_name || i.name || ''
      })))
      console.log('‚Ä¢ items total:', rawItems.length, ' | with variant_sku:', withSku.length, ' | without:', noSku.length)

      if (!withSku.length) {
        console.warn('‚ÄºÔ∏è –Ω–µ–º–∞—î –ø–æ–∑–∏—Ü—ñ–π –∑ variant_sku ‚Äî –ø–æ–¥—ñ—é –ø—Ä–æ–ø—É—â–µ–Ω–æ')
        console.groupEnd(); return
      }

      const items = withSku.map(i => ({
        variant_sku: String(i.variant_sku),
        price: toNumber(i.price),
        quantity: Number(i.quantity || 1),
        name: i.product_name || i.name || ''
      }))

      const computedItemsSum = items.reduce((s, x) => s + x.price * x.quantity, 0)
      const payload = {
        order_number: ord.order_number || ord.id || undefined,
        items,
        value: toNumber(
          (ord.total ?? ord.total_price ?? ord.total_amount ?? computedItemsSum)
        ),
        currency: ord.currency || window.metaPixelCurrency || 'UAH',
        shipping: toNumber(ord.shipping_cost ?? ord.delivery_cost ?? 0),
        tax: toNumber(ord.tax ?? 0),

        // PII ‚Äî –ø—ñ–¥–µ –ª–∏—à–µ —É CAPI –Ω–∞ –±–µ–∫ (Pixel –Ω–µ –æ—Ç—Ä–∏–º–∞—î PII)
        email: ord.customer?.email || null,
        phone: ord.customer?.phone || null,
        first_name: ord.customer?.first_name || ord.customer?.name || null,
        last_name: ord.customer?.last_name || null,
        external_id: ord.customer?.id ? String(ord.customer.id) : null
      }

      console.log('‚Ä¢ payload ready (trimmed):', {
        order_number: payload.order_number,
        currency: payload.currency,
        value: payload.value,
        shipping: payload.shipping,
        tax: payload.tax,
        items: payload.items
      })

      const tryCall = (attempt = 0) => {
        const exists = typeof window.mpTrackPurchase === 'function'
        console.log(`‚Ä¢ tryCall #${attempt} | mpTrackPurchase present:`, exists)
        if (exists) {
          window.mpTrackPurchase(payload)
          sent = true
          console.info('‚úÖ mpTrackPurchase called')
          console.groupEnd()
        } else if (attempt < 120) {
          setTimeout(() => tryCall(attempt + 1), 80)
        } else {
          console.warn('‚ùå mpTrackPurchase is not available after retries')
          console.groupEnd()
        }
      }
      tryCall()
    } catch (e) {
      console.warn('[Purchase] exception in prepare', e)
      console.groupEnd()
    }
  }
})()
/* ================================================================================ */

onMounted(async () => {
  const orderNumber = localStorage.getItem('lastOrderNumber')
  console.log('%c[ThankYou] orderNumber from LS:', 'color:#6c5ce7', orderNumber)

  if (!orderNumber) {
    console.warn('[ThankYou] no orderNumber ‚Äî redirect to home')
    window.location.href = '/'
    return
  }

  try {
    const { data } = await axios.get(`/api/orders/${orderNumber}`)
    order.value = data

    console.groupCollapsed('%c[ThankYou] fetched order', 'color:#2ecc71')
    console.log('‚Ä¢ raw order:', JSON.parse(JSON.stringify(data)))
    console.table((data.items || []).map(i => ({
      id: i.id,
      product_id: i.product_id,
      variant_id: i.variant_id,
      variant_sku: i.variant_sku,
      size: i.size,
      price: i.price,
      qty: i.quantity,
    })))
    console.groupEnd()

    // üîî –í—ñ–¥–ø—Ä–∞–≤–ª—è—î–º–æ Purchase –û–î–ò–ù –†–ê–ó (—á–µ—Ä–µ–∑ –≥–ª–æ–±–∞–ª–∫—É –∑ –ø–∞—Ä—à–∞–ª—É)
    trackPurchaseOnce(order.value)

    // –û—á–∏—Å—Ç–∫–∞ –ø—ñ—Å–ª—è —É—Å–ø—ñ—à–Ω–æ–≥–æ –æ—Ç—Ä–∏–º–∞–Ω–Ω—è (–Ω–µ —á—ñ–ø–∞—î–º–æ guard –∫–ª—é—á —ñ–∑ –ø–∞—Ä—à–∞–ª—É)
    localStorage.removeItem('lastOrderNumber')
    localStorage.removeItem('cart')
    localStorage.removeItem('thankyou')
    sessionStorage.removeItem('checkout')
    sessionStorage.clear()
    cart.clearCart?.()
  } catch (error) {
    console.error('‚ùå –ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –∑–∞–ø–∏—Ç—ñ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è:', error)
  }
})
</script>
